(()=>{"use strict";(()=>{const e=document.querySelector("main"),t=document.querySelectorAll("fieldset"),o=document.querySelector('input[name="address"]');let n=document.querySelector(".map");window.adFormAddress=o,window.fieldsets=t,window.KODE_ESC=27,window.map=n,window.mainOne=e,window.lockdown=function(){for(let e=0;e<t.length;e++)t[e].setAttribute("disabled","")},window.lockdown()})(),(()=>{let e=null;window.debounce=function(){e&&window.clearTimeout(e),e=window.setTimeout((function(){window.matches()}),500)}})(),window.closeBanner=(e,t,o)=>{e.remove(),document.removeEventListener("keydown",t),o&&document.removeEventListener("mouseup",o)},(()=>{let e=window.map.querySelector("form");window.formReset=function(t){let o=window.adForm.querySelector(".ad-form__photo-container").querySelector(".ad-form__photo"),n=window.map.querySelectorAll('button[type="button"]');window.map.querySelector(".popup")&&window.closeCardBigButton(t),o&&o.remove(),window.adForm.reset(),e.reset(),window.mainOne.style=null,window.map.classList.add("map--faded"),window.lockdown(),window.adForm.classList.add("ad-form--disabled"),window.mapPinMain.style.left="570px",window.mapPinMain.style.top="375px",window.adFormAddress.value=window.mapPinMain.offsetLeft+Math.ceil(32.5)+" "+(window.mapPinMain.offsetTop+Math.ceil(32.5)),e.style.opacity=null;for(let e=n.length-1;e>=0;e--){let t=n[e];t.parentElement.removeChild(t)}}})(),(()=>{let e=document.createElement("div"),t=document.createElement("div"),o=document.querySelector("main");window.mainBody=o,window.pullErrorHandler=function(n){e.classList.add("error"),t.classList.add("error__inner"),t.textContent=n,o.insertAdjacentElement("afterbegin",e),e.insertAdjacentElement("afterbegin",t);let r=function(t){t.keyCode===window.KODE_ESC&&(t.preventDefault(),e.remove(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r)}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);window.pushGoodData=function(){window.mainOne.style.position="fixed",window.formReset(),window.mainBody.insertAdjacentElement("afterbegin",e);let t=()=>{window.closeBanner(e,o,t)},o=function(n){n.keyCode===window.KODE_ESC&&(n.preventDefault(),window.closeBanner(e,o,t))};document.addEventListener("keydown",o),document.addEventListener("mouseup",t)}})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=e.querySelector(".error__button");window.pushErrorData=function(){window.mainOne.style.position="fixed",window.mainBody.insertAdjacentElement("afterbegin",e);let o=function(){e.remove(),window.mainOne.style.position=null,t.removeEventListener("click",o),document.removeEventListener("keydown",n),document.removeEventListener("mouseup",o)},n=function(e){e.keyCode===window.KODE_ESC&&(e.preventDefault(),o())};t.addEventListener("click",o),document.addEventListener("keydown",n),document.addEventListener("mouseup",o)}})(),window.backend={serverServices:function(e,t,o){let n,r=new XMLHttpRequest;r.responseType="json",n=o?"https://21.javascript.pages.academy/keksobooking":"https://21.javascript.pages.academy/keksobooking/data",r.addEventListener("load",(function(){200===r.status?e(r.response):t("Статус ответа сервера: "+r.status+" "+r.statusText)})),r.addEventListener("error",(function(){t("Произошла ошибка соединения с сервером")})),r.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+r.timeout+"мс")})),r.timeout=1e4,o?(r.open("POST",n),r.send(o)):(r.open("GET",n),r.send())},load:function(e,t){this.serverServices(e,t)},save:function(e,t,o){this.serverServices(e,t,o)}},(()=>{const e=document.querySelector(".ad-form");window.adForm=e,window.formFullung=function(){const t=e.querySelector("#type"),o=e.querySelector("#price"),n=e.querySelector("#timein"),r=e.querySelector("#timeout"),i=n.querySelectorAll("option"),l=r.querySelectorAll("option"),d=e.querySelector("#room_number"),a=e.querySelector("#capacity").querySelectorAll("option"),s=e.querySelector("#avatar"),u=e.querySelector("#images"),c=e.querySelector(".ad-form-header__preview").querySelector("img"),w=e.querySelector(".ad-form__photo"),p=e.querySelector(".ad-form__reset");window.adFormReset=p,o.placeholder=1e3,o.min=1e3,s.addEventListener("change",(function(){window.checkingFile(s,c)})),u.addEventListener("change",(function(){let e=document.createElement("img");w.appendChild(e),window.checkingFile(u,e)}));for(let e=0;e<a.length;e++)"1"===a[e].value?a[2].removeAttribute("disabled"):a[e].setAttribute("disabled","");let f=function(e,t){for(let t=0;t<e.length;t++)e[t].removeAttribute("selected");for(let o=0;o<e.length;o++)e[o].value===t&&e[o].setAttribute("selected","")};t.onchange=function(){let e=function(e){let t;switch(e){case"bungalow":t=0;break;case"flat":t=1e3;break;case"house":t=5e3;break;case"palace":t=1e4}return t}(t.value);o.placeholder=e,o.min=e},n.onchange=function(){f(l,n.value)},r.onchange=function(){f(i,r.value)},d.onchange=function(){!function(e){for(let e=0;e<a.length;e++)a[e].removeAttribute("disabled"),a[e].removeAttribute("selected");switch(e){case"100":for(let e=0;e<a.length-1;e++)a[e].setAttribute("disabled","");a[3].setAttribute("selected","");break;case"3":a[3].setAttribute("disabled",""),a[0].setAttribute("selected","");break;case"2":a[1].setAttribute("selected",""),a[0].setAttribute("disabled",""),a[3].setAttribute("disabled","");break;case"1":for(let e=0;e<a.length;e++)"1"===a[e].value?a[2].setAttribute("selected",""):a[e].setAttribute("disabled","")}}(d.value)},e.addEventListener("submit",(function(t){t.preventDefault(),window.backend.save(window.pushGoodData,window.pushErrorData,new FormData(e))}))}})(),(()=>{let e=document.querySelector(".map__pin--main"),t=e.querySelector("svg"),o=e.querySelector("img");const n=window.map.querySelector(".map__pins");window.listAddresses=void 0,window.mapPinMain=e,window.adFormAddress.value=e.offsetLeft+Math.ceil(32.5)+" "+(e.offsetTop+Math.ceil(32.5));const r=(r,i)=>{const l=n.offsetWidth;let d={x:r.clientX,y:r.clientY};const a=Math.floor(n.getBoundingClientRect().left),s=Math.floor(n.getBoundingClientRect().top);let u,c,w,p=Math.ceil(i.getBoundingClientRect().left)+Math.ceil(i.getBoundingClientRect().width)/2-r.pageX;i===t?(u=Math.ceil(i.getBoundingClientRect().top)+Math.ceil(i.getBoundingClientRect().height)/2-r.pageY,c=Math.ceil(i.getBoundingClientRect().height/2)):(u=Math.ceil(i.getBoundingClientRect().top)+82-r.pageY,c=82),w=window.scrollY<=130?s+(130+c)-window.scrollY:-(window.scrollY-c);let f=a,m=a+l,y=w,g=707+s+s,h=function(o){if(o.preventDefault(),o.clientX+p>=f&&o.clientX+p<m&&o.clientY+u>=y&&o.clientY+u<g){let n={x:d.x-o.clientX,y:d.y-o.clientY};d={x:o.clientX,y:o.clientY},e.style.left=e.offsetLeft-n.x+"px",e.style.top=e.offsetTop-n.y+"px",window.adFormAddress.value=i===t?e.offsetLeft-n.x+Math.ceil(32.5)+" "+(e.offsetTop-n.y+Math.ceil(32.5)):e.offsetLeft-n.x+Math.ceil(32.5)+" "+(e.offsetTop-n.y+82)}},v=function(e){e.preventDefault(),i===o&&window.backend.load(window.successHandler,window.pullErrorHandler),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",v)};document.addEventListener("mousemove",h),document.addEventListener("mouseup",v)};window.successHandler=function(e){window.listAddresses=e,window.map.querySelector("form").style.opacity="1",window.placemaks(window.listAddresses)},o.addEventListener("mousedown",(function(e){e.preventDefault(),window.map.classList.remove("map--faded"),window.map.querySelector("form").style.opacity="0";for(let e=0;e<window.fieldsets.length;e++)window.fieldsets[e].removeAttribute("disabled");window.adForm.classList.remove("ad-form--disabled"),r(e,o),window.formFullung()})),t.addEventListener("mousedown",(function(e){e.preventDefault(),r(e,t)}))})(),(()=>{const e=["gif","jpg","jpeg","png"];window.checkingFile=(t,o)=>{let n=t.files[0],r=n.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){o.src=e.result})),e.readAsDataURL(n)}}})(),window.closeCardBigButton=()=>{window.closeBanner(window.popup,window.closeCardBigEsc),window.closeButtenPopup.removeEventListener("mouseup",window.closeCardBigButton)},window.sortingAdsFiltered=e=>{let t=window.adFormAddress.value.split(" ");return e.sort((function(e,o){return Math.round(Math.sqrt(Math.pow(t[0]-e.location.x,2)+Math.pow(t[1]-e.location.y,2)))-Math.round(Math.sqrt(Math.pow(t[0]-o.location.x,2)+Math.pow(t[1]-o.location.y,2)))})),e},window.closeAllPinOnMap=function(){let e=window.map.querySelectorAll('button[type="button"]');for(let t=e.length-1;t>=0;t--){let o=e[t];o.parentElement.removeChild(o)}},window.closeActivePin=function(){let e=window.map.querySelectorAll('button[type="button"]');for(let t=0;t<e.length;t++)e[t].classList.remove("map__pin--active")},window.closeCardBig=function(){let e=window.map.querySelector(".popup");window.closeBanner(e,window.closeCardBigEsc)},window.drawingPlacemarksMap=function(e){const t=document.querySelector("#pin").content;let o=document.createDocumentFragment(),n=e=>{let o=t.querySelector(".map__pin").cloneNode(!0);return o.style.left=e.location.x+"px",o.style.top=e.location.y+"px",o.querySelector("img").src=e.author.avatar,o};e=(e=window.sortingAdsFiltered(e)).slice(0,5);for(let t=0;t<e.length;t++)o.appendChild(n(e[t]));window.map.appendChild(o);let r=window.map.querySelectorAll('button[type="button"]');for(let e=0;e<r.length;e++)r[e].onclick=function(e){window.pinActivation(e)};window.map.querySelector(".popup")&&window.closeCardBig()},window.placemaks=function(e){const t=document.querySelector("#card").content;window.map.querySelector(".popup")&&window.closeCardBig(),window.closeCardBigEsc=e=>{if(e.keyCode===window.KODE_ESC){e.preventDefault();let t=window.map.querySelector(".popup");window.closeBanner(t,window.closeCardBigEsc),window.closeActivePin()}},window.map.querySelector('button[type="button"]')&&window.closeAllPinOnMap(),window.adsFiltered=[];for(let t=0;t<e.length;t++)if(e[t].offer){let o=e[t];window.adsFiltered.push(o)}window.filteringByValue(window.adsFiltered),window.pinActivation=e=>{if(e.target&&e.target.closest('button[type="button"]')||e.target&&e.target.matches('button[type="button"]')){let o=e.target.closest('button[type="button"]');window.closeActivePin(),o.classList.add("map__pin--active");let n=window.adsFiltered.find((function(e){return e.location.x===parseInt(o.style.left,10)&&e.location.y===parseInt(o.style.top,10)}));window.map.appendChild((e=>{let o=t.querySelector(".map__card").cloneNode(!0);window.map.querySelector(".popup")&&window.closeCardBig(),o.querySelector(".popup__avatar").src=e.author.avatar,o.querySelector(".popup__title").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.address,o.querySelector(".popup__text--price").innerHTML=e.offer.price+"&#x20bd;<span>/ночь</span>";let n=e=>{let t;return t=1===e?" 1 гостя":" "+e+" гостей",t};if(o.querySelector(".popup__type").textContent=(e=>{let t;switch(e){case"bungalow":t="Бунгало";break;case"flat":t="Квартира";break;case"house":t="Дом";break;case"palace":t="Дворец"}return t})(e.offer.type),0===e.offer.rooms&&o.querySelector(".popup__text--capacity").remove(),1===e.offer.rooms&&(o.querySelector(".popup__text--capacity").innerHTML=e.offer.rooms+" комната для "+n(e.offer.guests)),2!==e.offer.rooms&&3!==e.offer.rooms||(o.querySelector(".popup__text--capacity").innerHTML=e.offer.rooms+" комнаты для "+n(e.offer.guests)),"palace"===e.offer.type&&(o.querySelector(".popup__text--capacity").innerHTML=e.offer.rooms+" комнат для"+n(e.offer.guests)),o.querySelector(".popup__text--time").innerHTML="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout,0===e.offer.features.length)o.querySelector(".popup__features").remove();else{let t=o.querySelector(".popup__features").children;for(let e=t.length-1;e>=0;e--){let o=t[e];o.parentElement.removeChild(o)}for(let t=0;t<e.offer.features.length;t++){let n=e.offer.features[t],r=document.createElement("li");r.classList.add("popup__feature");let i="popup__feature--"+n;r.classList.add(i),o.querySelector(".popup__features").appendChild(r)}}e.offer.description?o.querySelector(".popup__description").textContent=e.offer.description:o.querySelector(".popup__description").remove();let r=document.createDocumentFragment(),i=o.querySelector(".popup__photos"),l=i.cloneNode(!0);i.querySelector("img").remove();let d=e=>{let t=l.querySelector(".popup__photo").cloneNode();return t.src=e,t};if(0===e.offer.photos)i.remove();else{for(let t=0;t<e.offer.photos.length;t++)r.appendChild(d(e.offer.photos[t]));i.appendChild(r)}return document.addEventListener("keydown",window.closeCardBigEsc),o})(n));let r=window.map.querySelector(".popup");window.popup=r;let i=window.popup.querySelector(".popup__close");window.closeButtenPopup=i,window.closeButtenPopup.addEventListener("mouseup",window.closeCardBigButton)}};let o=window.map.querySelectorAll('button[type="button"]');for(let e=0;e<o.length;e++)o[e].onclick=function(e){window.pinActivation(e)};window.adFormReset.addEventListener("click",(function(e){e.preventDefault(),window.formReset(e)}))},window.filteringByValue=e=>{const t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),l=t.querySelector("#housing-features");let d={};window.matches=()=>{let t=e;for(let e in d)d.hasOwnProperty(e)&&(t=t.filter((function(t){if("housingType"===e)return t.offer.type===d[e];if("housingPrice"===e){if("middle"===d[e])return t.offer.price>=1e4&&t.offer.price<=5e4;if("low"===d[e])return t.offer.price<1e4;if("high"===d[e])return t.offer.price>5e4}if("housingRooms"===e)return t.offer.rooms===parseInt(d[e],10);if("housingGuests"===e)return t.offer.guests===parseInt(d[e],10);if("housingFeatures"===e){let e=!0;for(let o=0;o<d.housingFeatures.length;o++)if(!1===t.offer.features.some((function(e){return e===d.housingFeatures[o]})))return e=!1,e;return e}return null})));window.adsFiltered=t,window.closeAllPinOnMap(),window.drawingPlacemarksMap(window.adsFiltered)},window.drawingPlacemarksMap(window.adsFiltered),o.onchange=function(){d.housingType=o.value,"any"===o.value&&delete d.housingType,window.debounce()},n.onchange=function(){d.housingPrice=n.value,"any"===n.value&&delete d.housingPrice,window.debounce()},r.onchange=function(){d.housingRooms=r.value,"any"===r.value&&delete d.housingRooms,window.debounce()},i.onchange=function(){d.housingGuests=i.value,"any"===i.value&&delete d.housingGuests,window.debounce()},l.addEventListener("change",(e=>{if(e.target&&e.target.matches('input[type="checkbox"]')){if(d.housingFeatures){let t=0;d.housingFeatures.some((function(o,n){return t=n,o===e.target.value}))?d.housingFeatures.splice(t,1):d.housingFeatures.push(e.target.value)}else d.housingFeatures=[],d.housingFeatures.push(e.target.value);0===d.housingFeatures.length&&delete d.housingFeatures}window.debounce()}))}})();